
stages:
  - build
  - deploy
  - performance

build:
  stage: build
  script:
    - echo "in building phase"

deploy:
  stage: deploy
  image: docker:stable
  services:
    - docker:stable-dind
  script:
    - echo "docker info"
    - docker info
    - echo "here we will deploy"
    - docker build -t myapp-image .
    - docker run --name=myapp -d myapp-image
    - echo "running succesfully"

performance:
  stage: performance
  image: docker:git
  variables:
    URL: https://www.flipkart.com
  services:
    - docker:stable-dind
  script:
    - mkdir gitlab-exporter
    - wget -O ./gitlab-exporter/index.js https://gitlab.com/gitlab-org/gl-performance/raw/master/index.js
    - mkdir sitespeed-results
    - docker run --shm-size=1g --rm -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io:6.3.1 --plugins.add ./gitlab-exporter --outputFolder sitespeed-results $URL
    - mv sitespeed-results/data/performance.json performance.json
  artifacts:
    paths:
      - sitespeed-results/
    reports:
      performance: performance.json

#code_quality:
#  image: docker:stable
#  variables:
#    DOCKER_DRIVER: overlay2
#  allow_failure: true
#  services:
#    - docker:stable-dind
#  script:
#    - export SP_VERSION=$(echo "$CI_SERVER_VERSION" | sed 's/^\([0-9]*\)\.\([0-9]*\).*/\1-\2-stable/')
#    - docker run
#        --env SOURCE_CODE="$PWD"
#        --volume "$PWD":/code
#        --volume /var/run/docker.sock:/var/run/docker.sock
#        "registry.gitlab.com/gitlab-org/security-products/codequality:$SP_VERSION" /code
#  artifacts:
#    reports:
#      codequality: gl-code-quality-report.json
